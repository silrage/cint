/*! cint 26-12-2016 */
"use strict";function supports_html5_storage(){try{return"localStorage"in window&&window.localStorage!==null}catch(e){return false}}function safe_key(module){var key;if(module==="VK"){var spl="code=";var href=window.location.href;key=href.slice(href.indexOf(spl)+spl.length)}return key}function connect(params,transport,object){var url="/vk/obj.php";if(params.task!=null)url+="?task="+params.task;if(params.task==="upload"){url+="&url=upload";return transport.post(url,object,{transformRequest:angular.identity,headers:{"Content-Type":undefined}})}else{return transport({method:"POST",url:url,headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{url:params.url,obj:JSON.stringify(object)},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")}})}}function getPhotosMaxRes(stack){if(stack){var obj=[];angular.forEach(stack,function(v,i){if(v.src_xxbig){obj[i]=v.src_xxbig}else if(v.src_xbig){obj[i]=v.src_xbig}else if(v.src_big){obj[i]=v.src_big}else{obj[i]=v.src}});return obj}}function copyPhotos(fields,transport,token,countMax,collection,taskmng){var owner_id=-fields.group;connect({url:"copy",task:"copy"},transport,{group_id:owner_id,album_id:fields.album,destination_group:fields.destination_group,destination_album:fields.destination_album,token:token,offset:collection,count:countMax}).then(function(resp){if(resp.data){if(resp.data.count){var count=collection+parseInt(resp.data.count);if(count<countMax){return copyPhotos(fields,transport,token,countMax,count,taskmng)}else{taskmng("vk","");return}}else{taskmng("vk","");console.info(resp.data,"ERROR")}}})}var sets={},authorized={},profile={},App=angular.module("cint",["ngRoute"]),routes=function($httpProvider,$routeProvider,$locationProvider,$http){$httpProvider.defaults.headers.common["X-Requested-With"]="XMLHttpRequest";$routeProvider.when("/",{templateUrl:"/main.php"}).when("/access_token=:token",{templateUrl:"/panel.php"}).when("/panel",{templateUrl:"/panel.php"}).otherwise({redirectTo:"/"});$locationProvider.html5Mode({enabled:true,requireBase:false})};App.config(["$httpProvider","$routeProvider","$locationProvider",routes]).run(["$http","$window","$rootScope",function($http,$window,$rootScope){$http({url:"/settings.json"}).success(function(file){sets=file[0].plugins})}]).controller("getOBJ",["$rootScope","$scope","$http","$timeout","$routeParams","$location",function($rootScope,$scope,$http,$timeout,$routeParams,$location){var taskmng=function(module,task){$rootScope.tasks[module]=task};$rootScope.tasks={vk:"",insta:""};function mainLoad(){if(supports_html5_storage()){if(localStorage.getItem("authorize")){var auth=localStorage.getItem("authorize");switch(auth){case"VK":console.log("VK auth processing..");var code=safe_key("VK");$location.path("/panel");$location.search("");$scope.VK.SetToken(code);break;default:localStorage.removeItem("authorize");break}}else{if(localStorage.getItem("vk_token")){var token=localStorage.getItem("vk_token");var uid=localStorage.getItem("vk_uid");authorized.vk={token:token};connect({url:"https://api.vk.com/method/users.get?fields=photo_200,id&access_token="+token},$http,false).then(function(resp){if(resp.data.error===undefined){profile.vk=resp.data.response[0];$scope.profile.vk=resp.data.response[0]}else{Message.View(resp.data.error,false)}})}}}else{Message.View("No access local storage. Check browser for work this app.",false)}}var Message={View:function(str,dialog){console.log(str)}};$scope.VK={Authorize:function(){localStorage.setItem("authorize","VK");window.location="https://oauth.vk.com/authorize?client_id="+sets.vk.client_id+"&redirect_uri=http://cint.dev&scope=photos"},Fields:{group:"30666517",album:"202494715",destination_group:"73586529",destination_album:"237714121",photo:"",photoFile:{}},Result:"",SetToken:function(code){if(code!==null){$timeout(function(){connect({url:"https://oauth.vk.com/access_token?client_id="+sets.vk.client_id+"&client_secret="+sets.vk.client_secret+"&redirect_uri=http://cint.dev&code="+code},$http,false).then(function(resp){if(resp.status===200){if(resp.data.access_token!==null){var token=resp.data.access_token;localStorage.setItem("vk_token",token);localStorage.setItem("vk_uid",resp.data.user_id);localStorage.removeItem("authorize");connect({url:"https://api.vk.com/method/users.get?fields=photo_200&access_token="+token},$http,false).then(function(resp){if(resp.data.response!==undefined){profile.vk=resp.data.response[0];$scope.profile.vk=resp.data.response[0]}});authorized.vk={token:token};$scope.VK.View(token)}}})})}},Action:function(task){var token=localStorage.getItem("vk_token");var uid=localStorage.getItem("vk_uid");var ListActions=["get_groups","get_albums","get_photos","get_comments","copy_photos","push_photos","save_photos"];taskmng("vk",task);if(task==="get_tasks_list"){taskmng("vk","");return ListActions}else if(task==="get_groups"){connect({url:"https://api.vk.com/method/groups.get?user_id="+uid+"&extended=1&offset=0&count=10&access_token="+token},$http,false).then(function(resp){delete resp.data.response[0];$scope.VK.Result=resp.data.response.sort();console.log($scope.VK.Result)})}else if(task==="get_albums"){var oid=this.Fields.group;if(oid!=""){connect({url:"https://api.vk.com/method/photos.getAlbums?owner_id="+oid+"&offset=0&count=100&access_token="+token},$http,false).then(function(resp){$scope.VK.Result=resp.data.response.sort();console.log(resp.data.response)})}}else if(task==="get_photos"){var oid=this.Fields.group;var aid=this.Fields.album;if(oid!=""&&aid!=""){connect({url:"https://api.vk.com/method/photos.get?owner_id="+oid+"&album_id="+aid+"&offset=0&count=40&access_token="+token},$http,false).then(function(resp){$scope.VK.Result=resp.data.response.sort();console.log(resp.data.response)})}}else if(task==="get_comments"){var oid=this.Fields.group;var pid=this.Fields.photo;if(oid!=""&&pid!=""){connect({url:"https://api.vk.com/method/photos.getComments?owner_id="+oid+"&photo_id="+pid+"&count=10&access_token="+token},$http,false).then(function(resp){console.log(resp.data.response)})}}else if(task==="copy_photos"){var oid=this.Fields.group;var aid=this.Fields.album;var fields=this.Fields;if(oid!=""&&aid!=""){connect({url:"https://api.vk.com/method/photos.get?owner_id=-"+oid+"&album_id="+aid+"&offset=0&count=1&v=5.60&access_token="+token},$http,false).then(function(resp){var count=resp.data.response.count;copyPhotos(fields,$http,token,count,0,taskmng)})}}else if(task==="push_photos"){console.log(this.Fields);var formData=new FormData;formData.append("file",this.Fields.photoFile);var url="upload";$http.post("/vk/obj.php?task=upload&url=upload&group_id="+this.Fields.group+"&album_id="+this.Fields.album+"&token="+token,formData,{transformRequest:angular.identity,headers:{"Content-Type":undefined}})}else if(task==="save_photos"){var oid=this.Fields.group;var aid=this.Fields.album;if(oid!=""&&aid!=""){connect({url:"https://api.vk.com/method/photos.get?owner_id=-"+oid+"&album_id="+aid+"&offset=0&count=100&access_token="+token},$http,false).then(function(resp){var collection=resp.data.response;var getMaxPhotos=getPhotosMaxRes(collection)})}}},View:function(token){Message.View("auth success",false);var uid=localStorage.getItem("vk_uid")},Exit:function(){window.location="/panel";localStorage.removeItem("vk_uid");localStorage.removeItem("vk_token");delete $scope.auth.vk;delete authorized.vk}};$scope.vkListActions=$scope.VK.Action("get_tasks_list");mainLoad();$scope.auth=authorized;$scope.profile=profile}]).directive("vkPanel",function(){return{restrict:"E",templateUrl:"vk.tpl"}}).directive("instaPanel",function(){return{restrict:"E",templateUrl:"insta.tpl"}}).directive("fileread",[function(){return{scope:{fileread:"="},link:function(scope,element,attributes){element.bind("change",function(changeEvent){scope.$apply(function(){scope.fileread=changeEvent.target.files[0]})})}}}]);