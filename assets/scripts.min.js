/*! cint 27-10-2016 */
"use strict";function supports_html5_storage(){try{return"localStorage"in window&&window.localStorage!==null}catch(e){return false}}function safe_key(module){var key;if(module==="VK"){var spl="code=";var href=window.location.href;key=href.slice(href.indexOf(spl)+spl.length)}return key}function connect(url,transport){return transport({method:"POST",url:"/vk/obj.php",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{url:url},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")}})}var sets={},authorized={},profile={},App=angular.module("cint",["ngRoute"]),routes=function($httpProvider,$routeProvider,$locationProvider,$http){$httpProvider.defaults.headers.common["X-Requested-With"]="XMLHttpRequest";$routeProvider.when("/",{templateUrl:"/main.php"}).when("/access_token=:token",{templateUrl:"/panel.php"}).when("/panel",{templateUrl:"/panel.php"}).otherwise({redirectTo:"/"});$locationProvider.html5Mode({enabled:true,requireBase:false})};App.config(["$httpProvider","$routeProvider","$locationProvider",routes]).run(["$http",function($http){$http({url:"/settings.json"}).success(function(file){sets=file[0].plugins})}]).controller("getOBJ",["$rootScope","$scope","$http","$timeout","$routeParams","$location",function($rootScope,$scope,$http,$timeout,$routeParams,$location){function mainLoad(){if(supports_html5_storage()){if(localStorage.getItem("authorize")){var auth=localStorage.getItem("authorize");switch(auth){case"VK":console.log("VK auth processing..");var code=safe_key("VK");$location.path("/panel");$location.search("");$scope.VK.SetToken(code);break;default:localStorage.removeItem("authorize");break}}else{if(localStorage.getItem("vk_token")){var token=localStorage.getItem("vk_token");var uid=localStorage.getItem("vk_uid");authorized.vk={token:token};connect("https://api.vk.com/method/users.get?fields=photo_200,id&access_token="+token,$http).then(function(resp){if(resp.data.response!==undefined){profile.vk=resp.data.response[0];$scope.profile.vk=resp.data.response[0]}})}}}else{Message.View("No access local storage. Check browser for work this app.",false)}}var Message={View:function(str,dialog){console.log(str)}};$scope.VK={Authorize:function(){localStorage.setItem("authorize","VK");window.location="https://oauth.vk.com/authorize?client_id="+sets.vk.client_id+"&redirect_uri=http://cint.dev&scope=photos"},SetToken:function(code){if(code!==null){$timeout(function(){var urlACT="https://oauth.vk.com/access_token?client_id="+sets.vk.client_id+"&client_secret="+sets.vk.client_secret+"&redirect_uri=http://cint.dev&code="+code;$http({method:"POST",url:"/vk/obj.php",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{url:urlACT},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")}}).then(function(resp){if(resp.status===200){if(resp.data.access_token!==null){var token=resp.data.access_token;localStorage.setItem("vk_token",token);localStorage.setItem("vk_uid",resp.data.user_id);localStorage.removeItem("authorize");connect("https://api.vk.com/method/users.get?fields=photo_200&access_token="+token,$http).then(function(resp){if(resp.data.response!==undefined){profile.vk=resp.data.response[0];$scope.profile.vk=resp.data.response[0]}});authorized.vk={token:token};$scope.VK.View(token)}}})})}},View:function(token){Message.View("auth success",false);var uid=localStorage.getItem("vk_uid");function getPhotosMaxRes(stack){if(stack){var obj=[];angular.forEach(stack,function(v,i){if(v.src_xxbig){obj[i]=v.src_xxbig}else if(v.src_xbig){obj[i]=v.src_xbig}else if(v.src_big){obj[i]=v.src_big}else{obj[i]=v.src}});return obj}}var vkURL="https://api.vk.com/method/groups.get?user_id="+uid+"&access_token="+token+"";$http({method:"POST",url:"/vk/obj.php",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:{url:vkURL},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")}}).then(function(resp){var collection=resp.data.response})},Exit:function(){window.location="/panel";delete authorized.vk}};mainLoad();$scope.auth=authorized;$scope.profile=profile}]).directive("vkPanel",function(){return{restrict:"E",templateUrl:"vk.tpl"}}).directive("instaPanel",function(){return{restrict:"E",templateUrl:"insta.tpl"}});